# Day 3: Users & Authentication

## Summary

Let's walk through the app and explore what we have already developed.

## Creating Users

Up to this point, our data model has consisted of only one database table containing statuses. We need to create a table to store user data.

**Exercise:** Generate a `User` model with the following string attributes: `email`, `screen_name`, `full_name`, `url`, `password_hash`, `password_salt`. Hint: [This guide](http://guides.rubyonrails.org/command_line.html#rails-generate) on using the `rails generate` command may come in handy.

## Validations

**Discuss:** What validation rules need to be in place?

Before writing validations, let's make sure our user fabricator is in a valid state.

We need to use sequences in our fabricator to prevent uniqueness issues. [Explore the docs](http://www.fabricationgem.org/#!sequences) to learn how.

**Exercise:** Implement validation rules with tests. This may help: [Active Record Validations](http://guides.rubyonrails.org/active_record_validations.html).

Feel free to use this regular expression for email addresses:

    /\A[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]+\z/

## Non-Column Attributes

Remember, at the end of the day our models are just plain old Ruby objects. Thus we can define our own methods that act like our "column" methods but don't actually map to a column. These are sometimes referred to as "virtual attributes" in the context of Active Record.

Such a column will come in handy for dealing with user passwords (since we want to be able to receive a "password" as input but never want to store it directly in the database):

```ruby
user = User.new
user.password = "pa$$w0rd"
user.save

user.password_hash = " ... " # some new hash
user.password_salt = " ... " # some new salt
```

The `password_hash` and `password_salt` are private. From the outside, we don't care to know how they are generated.

Let's implement a `password` attribute.

**Discuss:** What kind of validations do we need for passwords?

Introduce conditional validations.

## Active Record Callbacks

To auto-generate the hash and salt, we need to define a method that will get called before the object is saved.
Callbacks to the rescue!

[See the API docs](http://api.rubyonrails.org/classes/ActiveRecord/Callbacks.html) for a list of all the callbacks.

In this case, we'll use the `before_save` callback.

## BCrypt

BCrypt is nice encryption library. Add to the Gemfile:

    gem 'bcrypt-ruby', '~> 3.0.0'

Then, `require 'bcrypt'` in your `User` class.

We will use two different methods provided by this library:

- `BCrypt::Engine.generate_salt` to generate salt
- `BCrypt::Engine.hash_secret(password, salt)` to cipher the password

More info on the [BCrypt algorithm](http://en.wikipedia.org/wiki/Bcrypt)

## Add Password Encryption

Implement an `encrypt_password` callback that generates a salt and hashed password.

**Discuss:** What do we need to do in this method?

## Add Authentication Checking

Implement an `authenticate` class method that will check for a valid email/password combination.

**Discuss:** What do we need to do in this method?

- What inputs does the method need to accept?
- How should we determine if the provided credentials are correct?
- What should we return in each case?

Let's write unit tests, then implement the feature.

## Wiring up a Registration Form

**Discuss:** What do we need to add to our app to display a registration page? What "resources" are involved?

Let's use some built-in Rails generators to help us.

### Form Helpers

Explore the markup generated by the Rails form helpers and how to bind model data to a form.

Resources:

- [Form Helpers Guide](http://guides.rubyonrails.org/form_helpers.html)
- [form_for docs](http://api.rubyonrails.org/classes/ActionView/Helpers/FormHelper.html#method-i-form_for)

### Routing

Run `rake routes` to see where the form POST will get routed.

### Filtering User Input

Discuss the [strong_parameters](https://github.com/rails/strong_parameters) library and mass assignment vulnerabilites.

### Redirection versus Rendering

Discuss the difference between a redirect and render call in Rails. 

### Displaying Errors in the Interface

What if the user submits invalid input? We need to display the errors back to the user.

