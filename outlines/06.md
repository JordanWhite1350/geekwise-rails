# Day 6: Authentication

**Congratulations!** Today marks the halfway point.

We'll begin developing on the [Day 6](https://github.com/djreimer/flutter/tree/day-6) branch of [Flutter](https://github.com/djreimer/flutter). **Please clone my repository and begin on the `day-6` branch, even if you followed along last class.** I've added various styles and markup to the project.

    $ git clone git@github.com:djreimer/flutter.git
    $ cd flutter
    $ git checkout day-6

If you already have cloned my repository, `fetch` all changes, then `checkout` the branch:

    $ cd flutter
    $ git fetch origin
    $ git checkout -t origin/day-6

## The Final Project

If you haven't already, please check out the [spec for the final project](https://github.com/djreimer/geekwise-rails/blob/master/final-project/spec.md). Feel free to get started anytime. (Hint: there's quite a bit of overlap between what we've built so far in class and what you need to have in your final project).

## Testing the Registration Page

You didn't think you'd get off that easy, right?

Last class, we skipped writing tests for the registration page. Let's go back and add them now.

**Discuss:** What do we need to test?

- List out possible scenarios
- Setup each scenario
- Determine what we need to "assert" in each scenario

There's a nice [Rails guide](http://guides.rubyonrails.org/testing.html#functional-tests-for-your-controllers) for testing.

Some tools we'll be using:

- `assert_redirected_to` for redirection
- `flash[:notice]` to access data stored in the flash object
- `assert_difference` to test database insertion

## Login Form

**Discuss:** Can we treat the user authentication flow as a "resource"? What should we call the controller?

Create the controller using `rails generate controller` and implement a login form, writing tests first.

## Remembering Who Logged In

Rails makes it dead easy to (securely) store data across requests using session cookies. It's as simple as `session[:foo] = "bar"`.

**Discuss:** What do we need to test?

- List out possible scenarios
- Setup each scenario
- Determine what we need to "assert" in each scenario

Some implementation details:

- Extract session logic into `login_as` and `logout` methods
- Create a custom `assert_logged_in_as` method for easier testing
- Log the user in right after registration (test first)

## Restricting Access

Introduce `before_action` hooks and define an `authenticate_user!` method.

**Discuss:** Suppose someone tries to go to a restricted area (like the user settings page) and is not logged in. What should we do?

## User Settings Form

Discuss URL-driven design. What URL should we visit to reach our settings page? Does it make sense to have an ID in the URL? Introduce singular resources and restricting actions. Play around with routes and inspect them with `rake routes`.

Write some tests for the settings controller. How do our scenerios differ from previous tests?

**Exercise:** Finish out the settings form. Hint: you can pass a hash of data to the `update_attributes` method on model objects to update fields.

## Reducing Duplication with Partials

Let's extract our error messages markup into a partial.